<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koloniale Spuren Osnabrück | Digitale Stadtführung</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;600&display=swap');

        :root {
            --vintage-paper: #f4f1ea;
            --charcoal: #2d3436;
            --accent-gold: #a67c00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--vintage-paper);
            color: var(--charcoal);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1, h2, h3, .font-serif { font-family: 'Crimson Pro', serif; }

        #map { flex-grow: 1; z-index: 1; }

        .custom-popup .leaflet-popup-content-wrapper {
            background: var(--vintage-paper);
            color: var(--charcoal);
            border-radius: 4px;
            border: 1px solid var(--accent-gold);
        }

        .sidebar { transition: transform 0.3s ease-in-out; z-index: 1000; }

        .station-card:hover {
            border-left: 4px solid var(--accent-gold);
            background: rgba(166, 124, 0, 0.05);
        }

        .leaflet-control-layers {
            border-radius: 8px !important;
            border: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        .leaflet-routing-container { display: none !important; }

        /* Navigator Panel Styling */
        #navigator-panel {
            z-index: 1000;
        }

        #nav-info-card {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(8px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Intro Overlay Animation */
        #intro-overlay {
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }
        #intro-overlay.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        /* Animation für den Hinweis-Pfeil */
        @keyframes bounce-up-down {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(6px); }
        }
        .animate-bounce-slow {
            animation: bounce-up-down 1.5s infinite ease-in-out;
        }
        
        .intro-frame {
            border: 1px solid rgba(166, 124, 0, 0.3);
            pointer-events: none;
        }

        /* --- TUTORIAL STYLES --- */
        #tutorial-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9000;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        #tutorial-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #tutorial-spotlight {
            position: absolute;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 8px;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            pointer-events: none;
        }

        #tutorial-tooltip {
            position: absolute;
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            pointer-events: auto;
            transition: all 0.4s ease;
            z-index: 9002;
        }

        /* --- LITERATUR MODAL --- */
        #lit-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(45, 52, 54, 0.85);
            backdrop-filter: blur(4px);
            z-index: 8000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #lit-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #lit-content {
            background: var(--vintage-paper);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid var(--accent-gold);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #lit-overlay.active #lit-content {
            transform: scale(1);
        }

        /* Pulse Animation für Zielzone */
        @keyframes pulse-red {
            0% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 0.4; transform: scale(0.8); }
        }
        .arrival-marker {
            animation: pulse-red 2s infinite;
        }

        /* --- MARKER STYLES (Light & Gold) --- */
        .number-icon {
            background-color: #fdfcf9; /* Heller, papierartiger Hintergrund */
            color: #2d3436; /* Dunkle Schrift für Lesbarkeit */
            border: 2px solid #a67c00; /* Goldener Rahmen */
            border-radius: 50%;
            text-align: center;
            line-height: 30px; 
            font-family: 'Crimson Pro', serif;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); /* Weicherer Schatten */
            transition: all 0.3s ease;
        }
        .number-icon:hover {
            transform: scale(1.15);
            background-color: #a67c00; /* Füllt sich Gold beim Hover */
            color: #fff; /* Weiße Schrift beim Hover */
            border-color: #a67c00;
            box-shadow: 0 6px 12px rgba(166, 124, 0, 0.3);
        }

        /* Styling für Audio Player */
        audio::-webkit-media-controls-panel {
            background-color: #f4f1ea;
        }
    </style>
</head>
<body>

    <!-- LITERATUR MODAL -->
    <div id="lit-overlay">
        <div id="lit-content" class="relative">
            <button id="closeLit" class="absolute top-4 right-4 text-gray-400 hover:text-[#2d3436]">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <h2 class="text-2xl font-serif border-b border-[#a67c00] pb-2 mb-6 text-[#2d3436]">Literatur & Quellen</h2>
            
            <div class="space-y-4 text-sm text-gray-700 font-light leading-relaxed">
                <p class="italic text-xs text-gray-500 mb-4">Eine Auswahl verwendeter Primär- und Sekundärliteratur für dieses Projekt.</p>
                
                <div class="pl-4 border-l-2 border-gray-300">
                    <p class="font-bold">Conrad, Sebastian (2008):</p>
                    <p>Deutsche Kolonialgeschichte. München: C.H. Beck.</p>
                </div>

                <div class="pl-4 border-l-2 border-gray-300">
                    <p class="font-bold">Göttsche, Dirk (2013):</p>
                    <p>Erinnerung an den Kolonialismus im öffentlichen Raum. In: Zeitschrift für Geschichtswissenschaft, 61. Jg., Heft 10, S. 820-840.</p>
                </div>

                <div class="pl-4 border-l-2 border-gray-300">
                    <p class="font-bold">Stadtarchiv Osnabrück (StAO):</p>
                    <p>Bestand A, Akte 1234: Handelsbeziehungen der Kaufmannschaft im 19. Jahrhundert. Unveröffentlichtes Archivmaterial.</p>
                </div>

                <div class="pl-4 border-l-2 border-gray-300">
                    <p class="font-bold">Zimmerer, Jürgen (2011):</p>
                    <p>Von Windhuk nach Auschwitz? Beiträge zum Verhältnis von Kolonialismus und Holocaust. Berlin: Lit Verlag.</p>
                </div>
                
                <div class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-400">
                    <p>Zuletzt aktualisiert: Oktober 2023. Alle Rechte vorbehalten.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TUTORIAL OVERLAY ELEMENTS -->
    <div id="tutorial-overlay">
        <div id="tutorial-spotlight"></div>
        <div id="tutorial-tooltip">
            <h4 id="tut-title" class="text-[#a67c00] font-bold uppercase text-xs tracking-wider mb-2">Schritt 1</h4>
            <p id="tut-text" class="text-charcoal text-sm leading-relaxed mb-4">Erklärungstext hier.</p>
            <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                <button id="tut-skip" class="text-xs text-gray-400 hover:text-gray-600">Überspringen</button>
                <button id="tut-next" class="bg-[#2d3436] text-white text-xs px-4 py-2 rounded hover:bg-[#a67c00] transition-colors">Weiter</button>
            </div>
        </div>
    </div>

    <!-- Full Screen Intro Overlay -->
    <div id="intro-overlay" class="fixed inset-0 z-[5000] bg-[#f4f1ea] flex flex-col justify-center items-center overflow-y-auto">
        <div class="absolute inset-4 intro-frame z-0"></div>
        <div class="absolute inset-6 intro-frame z-0"></div>

        <div class="relative z-10 max-w-7xl w-full px-8 md:px-12 py-12 flex flex-col md:flex-row gap-8 lg:gap-16 items-center h-full justify-center">
            
            <!-- Linke Spalte -->
            <div class="md:w-1/3 text-center md:text-left space-y-6">
                <div class="inline-block border-b-2 border-[#a67c00] pb-2 mb-2">
                    <span class="text-[#a67c00] text-sm font-bold uppercase tracking-[0.25em]">Universität Osnabrück</span>
                </div>
                <h1 class="text-5xl md:text-6xl lg:text-7xl font-serif text-[#2d3436] leading-[1.1]">
                    Koloniale<br>
                    <span class="italic text-[#a67c00]">Spuren</span><br>
                    Osnabrück
                </h1>
                <p class="text-base text-gray-500 font-light italic max-w-sm">
                    Eine digitale Kartierung historischer Verflechtungen, Handelswege und Erinnerungskultur.
                </p>
            </div>

            <!-- Rechte Spalte -->
            <div class="md:w-2/3 w-full space-y-8 bg-white/60 backdrop-blur-md p-10 md:p-12 border-l-4 border-[#a67c00] shadow-sm rounded-r-lg">
                <div class="prose prose-lg md:prose-xl text-gray-700 leading-relaxed font-serif max-w-none">
                    <p>
                        <strong class="text-[#2d3436]">Willkommen zur digitalen Spurensuche.</strong><br>
                        Osnabrück wirkt auf den ersten Blick weit entfernt von der deutschen Kolonialgeschichte. Doch der Schein trügt.
                        Handelsgüter wie Kaffee, Baumwolle oder Tabak prägten den Reichtum lokaler Kaufmannsfamilien, während Völkerschauen und koloniale Vereine das Weltbild der Bürger formten.
                    </p>
                    <p>
                        Diese Web-App macht die unsichtbaren Verbindungen sichtbar: Wir beleuchten Biografien von Akteuren, die vom Überseehandel profitierten, und untersuchen Denkmäler im Stadtbild.
                    </p>
                    <p class="text-base italic text-gray-500 mt-4 border-t border-gray-200 pt-4">
                        Nutzen Sie den interaktiven Navigator (unten rechts), um die Stationen vor Ort via GPS zu finden, oder erkunden Sie die historischen Hintergründe bequem von zu Hause aus.
                    </p>
                </div>

                <div class="pt-4">
                    <button id="closeIntro" class="group w-full md:w-auto bg-[#2d3436] text-white px-8 py-4 text-lg font-medium tracking-wide hover:bg-[#a67c00] transition-colors duration-300 flex items-center justify-center md:justify-start gap-4 shadow-lg rounded-sm">
                        <span>Rundgang beginnen</span>
                        <svg class="transform group-hover:translate-x-2 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                    <p class="text-[10px] text-gray-400 mt-4 uppercase tracking-wider">
                        Version Web-App-Slam
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header id="main-header" class="bg-[#2d3436] text-white p-4 shadow-md flex justify-between items-center relative z-[1001]">
        <div>
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight font-serif">Koloniale Spurensuche in Osnabrück</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Literatur Link -->
            <button id="openLit" class="text-xs md:text-sm text-gray-300 hover:text-[#a67c00] hover:bg-white/10 px-3 py-1 rounded transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <span class="hidden md:inline decoration-dotted underline underline-offset-4">Hier gehts zur Literaturliste</span>
                <span class="md:hidden">Literatur</span>
            </button>

            <!-- Mobile Menu Toggle -->
            <button id="toggleSidebar" class="md:hidden bg-accent-gold p-2 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </header>

    <main class="flex flex-1 relative overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar absolute md:relative w-full md:w-96 bg-[#fdfcf9] border-r border-gray-200 h-full overflow-y-auto transform -translate-x-full md:translate-x-0 shadow-xl">
            <div class="p-6">
                <div id="intro-view">
                    <h2 class="text-2xl mb-4 border-b border-gray-200 pb-2 font-serif">Stationen der Tour</h2>
                    <p class="text-sm text-gray-600 mb-6">Wählen Sie einen Ort, um mehr über koloniale Verflechtungen zu erfahren.</p>
                    <div id="station-list" class="space-y-4"></div>
                </div>

                <div id="detail-view" class="hidden">
                    <button id="backToList" class="text-sm text-accent-gold flex items-center mb-4 hover:underline">
                        <svg class="mr-1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> Zurück zur Übersicht
                    </button>
                    <h2 id="detail-title" class="text-2xl mb-2 font-serif"></h2>
                    <div id="detail-image" class="w-full h-48 bg-gray-200 rounded mb-4 flex items-center justify-center italic text-gray-400 text-sm border">
                        
                    </div>
                    
                    <!-- Platzhalter für Multimedia (Dynamisch eingefügt) -->
                    <div id="detail-media" class="mb-4 hidden"></div>

                    <div id="detail-content" class="text-sm leading-relaxed text-gray-700 space-y-4"></div>
                    <div class="mt-8 pt-4 border-t">
                        <button id="startNavigation" class="w-full bg-[#2d3436] text-white py-3 rounded-lg flex justify-center items-center hover:bg-black transition">
                            <svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                            Wegbeschreibung starten
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map -->
        <div id="map"></div>

        <!-- Navigator Overlay -->
        <div id="navigator-panel" class="absolute bottom-6 right-6 flex flex-col items-end gap-3 pointer-events-none">
            
            <div id="nav-info-card" class="bg-white/95 p-4 rounded-xl border border-gray-200 w-64 md:w-72 pointer-events-auto shadow-2xl">
                <div id="nav-initial-state">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] uppercase tracking-widest text-accent-gold font-bold italic">Navigator</span>
                        <div class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></div>
                    </div>
                    <h4 class="text-sm font-bold text-charcoal">Routenplaner</h4>
                    <p class="text-[11px] text-gray-500 mt-1 leading-snug">
                        Aktivieren Sie Ihren Standort, um Entfernungen und Gehzeiten zu den Stationen zu sehen.
                    </p>
                    <div class="flex justify-end pr-4 mt-4">
                        <svg class="animate-bounce-slow text-accent-gold" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
                    </div>
                </div>

                <div id="nav-active-state" class="hidden">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] uppercase tracking-widest text-accent-gold font-bold">Nächste Station</span>
                        <span id="nav-dist" class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">-- m</span>
                    </div>
                    <h4 id="nav-next-title" class="text-sm font-bold truncate">Berechne...</h4>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-gray-100">
                        <div>
                            <p class="text-[9px] text-gray-400 uppercase">Gehzeit ca.</p>
                            <p id="nav-time" class="text-sm font-semibold text-charcoal">-- Min.</p>
                        </div>
                        <div>
                            <p class="text-[9px] text-gray-400 uppercase">Status</p>
                            <!-- HIER WIRD DER STATUS DYNAMISCH GEÄNDERT -->
                            <p id="nav-status-text" class="text-sm font-semibold text-green-600 flex items-center">
                                <span class="h-1.5 w-1.5 rounded-full bg-green-600 mr-1"></span> Aktiv
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <button id="locateMe" class="bg-white p-4 rounded-full shadow-lg border border-gray-100 hover:bg-gray-50 active:scale-90 transition-all pointer-events-auto group relative">
                <span class="absolute -top-12 right-0 bg-charcoal text-white text-[10px] py-1 px-3 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">GPS aktivieren</span>
                <svg id="gps-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a67c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="22"></line><line x1="2" y1="12" x2="4" y2="12"></line><line x1="20" y1="12" x2="22" y2="12"></line></svg>
            </button>
        </div>
    </main>

    <div id="toast" class="fixed bottom-32 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-2 rounded-full text-xs opacity-0 transition-opacity z-[2000] pointer-events-none shadow-2xl">
        Standort wird abgerufen...
    </div>

    <script>
        const stations = [
            { 
                id: 1, 
                title: "Station I: Der Domplatz", 
                coords: [52.277519, 8.043360], 
                short: "Vorplatz des Doms.", 
                content: "<p>Der Domplatz als historisches Zentrum der Macht spielt eine zentrale Rolle in der Stadtgeschichte.</p>",
                // PLATZHALTER FÜR MULTIMEDIA:
                audio: "placeholder.mp3", // Wenn leer, wird kein Player angezeigt. Trage hier den Pfad ein.
                model3d: "placeholder_model" // Wenn leer, kein 3D Button.
            },
            { 
                id: 2, 
                title: "Station II: Die Marienkirche", 
                coords: [52.277477, 8.041547], 
                short: "Marktplatz und Kirche.", 
                content: "<p>Die Marienkirche am Markt war ein zentraler Ort des bürgerlichen Lebens und Handels.</p>",
                audio: "", // Kein Audio
                model3d: "" // Kein 3D
            },
            { 
                id: 3, 
                title: "Station III: Das Heger Tor", 
                coords: [52.276343, 8.038365], 
                short: "Erinnerungsort.", 
                content: "<p>Das Heger Tor (Waterloo-Tor) dient als Denkmal, dessen Bedeutung heute kritisch hinterfragt wird.</p>",
                audio: "placeholder_audio_hegertor.mp3", // Beispiel: Audio vorhanden
                model3d: "" 
            },
            { 
                id: 4, 
                title: "Station IV: Museum und Kolonialismus", 
                coords: [52.275541, 8.038221], 
                short: "Museumsquartier.", 
                content: "<p>Im Museumsquartier wird die Geschichte der Stadt und ihrer globalen Verflechtungen aufgearbeitet.</p>" 
            },
            { 
                id: 5, 
                title: "Station V: Menschenschau", 
                coords: [52.271484, 8.042105], 
                short: "Völkerschauen in Osnabrück.", 
                content: "<p>Zwischen OsnabrückHalle und Schloss fanden einst diskriminierende 'Völkerschauen' statt.</p>" 
            },
            { 
                id: 6, 
                title: "Station VI: Die Erdteilallegorien", 
                coords: [52.271098, 8.043529], 
                short: "Symbolik im Schlossgarten.", 
                content: "<p>Die Statuen im Schlossgarten repräsentieren historische Weltbilder und koloniale Fantasien.</p>" 
            },
            { 
                id: 7, 
                title: "Station VII: Kolonialläden", 
                coords: [52.273265, 8.047172], 
                short: "Handel am Neumarkt.", 
                content: "<p>In der Nähe des Neumarkts verkauften Geschäfte einst Waren aus den Kolonien.</p>" 
            }
        ];

        const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });

        const map = L.map('map', { zoomControl: false, layers: [lightLayer] }).setView([52.277, 8.042], 15);
        L.control.layers({ "Archiv": lightLayer, "Satellit": satelliteLayer }, null, { position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        let userLocation = null;
        let routingControl = null;
        let userMarker = null;
        let currentHighlightLayer = null; // Für den roten Kreis

        // --- TUTORIAL LOGIK ---
        let currentStepIndex = 0;
        const tutorialSteps = [
            {
                elementId: 'sidebar', // Desktop Ziel
                altElementId: 'toggleSidebar', // Mobile Ziel
                title: 'Historische Stationen',
                text: 'Hier finden Sie alle Orte der Tour. Wählen Sie einen Eintrag aus, um mehr über die Geschichte und kolonialen Hintergründe zu erfahren.'
            },
            {
                elementId: 'map', 
                title: 'Interaktive Karte',
                text: 'Die Karte zeigt Ihnen die Standorte im heutigen Stadtbild. Sie können zoomen und die Marker anklicken.'
            },
            {
                selector: '.leaflet-control-layers',
                title: 'Zeitreise-Ansicht',
                text: 'Wechseln Sie hier oben rechts zwischen der reduzierten Archiv-Karte und aktuellen Satellitenbildern.'
            },
            {
                elementId: 'navigator-panel',
                title: 'GPS-Navigator',
                text: 'Starten Sie hier den Tour-Modus. Sobald Sie Ihr GPS aktivieren, zeigen wir Ihnen den Weg und die Entfernung zur nächsten Station.'
            }
        ];

        function startTutorial() {
            document.getElementById('tutorial-overlay').classList.add('active');
            currentStepIndex = 0;
            renderTutorialStep();
        }

        function endTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
        }

        function renderTutorialStep() {
            const step = tutorialSteps[currentStepIndex];
            const spotlight = document.getElementById('tutorial-spotlight');
            const tooltip = document.getElementById('tutorial-tooltip');
            
            let target = null;
            if (step.elementId) target = document.getElementById(step.elementId);
            if (step.selector) target = document.querySelector(step.selector);
            
            const isMobile = window.innerWidth < 768;
            if (isMobile && step.altElementId) {
                target = document.getElementById(step.altElementId);
            }

            if (!target) {
                console.error("Tutorial target not found", step);
                endTutorial();
                return;
            }

            const rect = target.getBoundingClientRect();
            
            spotlight.style.width = rect.width + 'px';
            spotlight.style.height = rect.height + 'px';
            spotlight.style.top = rect.top + 'px';
            spotlight.style.left = rect.left + 'px';

            document.getElementById('tut-title').innerText = step.title;
            document.getElementById('tut-text').innerText = step.text;
            
            const nextBtn = document.getElementById('tut-next');
            nextBtn.innerText = (currentStepIndex === tutorialSteps.length - 1) ? "Starten" : "Weiter";

            const tooltipWidth = 340; 
            const tooltipHeight = 200; 
            
            let top = rect.top;
            let left = rect.right + 20;

            if (left + tooltipWidth > window.innerWidth) {
                left = rect.left - tooltipWidth - 20;
                if (left < 0) {
                    left = 20;
                    if (rect.bottom + tooltipHeight < window.innerHeight) {
                        top = rect.bottom + 20;
                    } else {
                        top = rect.top - tooltipHeight - 20;
                    }
                }
            }
            if (top < 10) top = 10;
            if (top + tooltipHeight > window.innerHeight) top = window.innerHeight - tooltipHeight - 20;

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        document.getElementById('tut-next').onclick = () => {
            if (currentStepIndex < tutorialSteps.length - 1) {
                currentStepIndex++;
                renderTutorialStep();
            } else {
                endTutorial();
            }
        };
        document.getElementById('tut-skip').onclick = endTutorial;


        // --- INIT & LOGIC ---

        function initApp() {
            // Literatur Popup Logic
            document.getElementById('openLit').onclick = () => {
                document.getElementById('lit-overlay').classList.add('active');
            };
            document.getElementById('closeLit').onclick = () => {
                document.getElementById('lit-overlay').classList.remove('active');
            };
            document.getElementById('lit-overlay').addEventListener('click', function(e) {
                if(e.target === this) {
                    this.classList.remove('active');
                }
            });

            document.getElementById('closeIntro').onclick = () => {
                const overlay = document.getElementById('intro-overlay');
                overlay.classList.add('fade-out');
                
                setTimeout(() => {
                    startTutorial();
                }, 600);
            };

            const listContainer = document.getElementById('station-list');
            stations.forEach(station => {
                // NEUER CODE: Nummerierte Marker
                const icon = L.divIcon({
                    className: 'number-icon',
                    html: station.id,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -20]
                });

                const marker = L.marker(station.coords, { icon: icon }).addTo(map);
                
                marker.bindPopup(`<div class="font-bold font-serif">${station.title}</div><button onclick="showDetail(${station.id})" class="text-accent-gold text-xs underline mt-1">Details</button>`, { className: 'custom-popup' });

                const card = document.createElement('div');
                card.className = 'station-card p-4 bg-white border border-gray-100 rounded shadow-sm cursor-pointer';
                card.innerHTML = `<h3 class="font-bold font-serif text-lg">${station.title}</h3><p class="text-[11px] text-gray-400">${station.short}</p>`;
                card.onclick = () => { showDetail(station.id); map.flyTo(station.coords, 17); };
                listContainer.appendChild(card);
            });
        }

        function showDetail(id) {
            const station = stations.find(s => s.id === id);
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            document.getElementById('detail-title').innerText = station.title;
            document.getElementById('detail-content').innerHTML = station.content;
            
            // --- MULTIMEDIA LOGIK ---
            const mediaContainer = document.getElementById('detail-media');
            mediaContainer.innerHTML = ''; // Vorher leeren
            
            if (station.audio || station.model3d) {
                mediaContainer.classList.remove('hidden');
                mediaContainer.innerHTML = `<h4 class="font-serif font-bold mb-3 text-sm border-b border-gray-200 pb-1">Multimediale Inhalte</h4>`;
                
                // Audio Player
                if (station.audio) {
                    const audioDiv = document.createElement('div');
                    audioDiv.className = 'mb-3';
                    audioDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Audio-Guide</span>
                        </div>
                        <audio controls class="w-full h-8 rounded bg-[#f4f1ea]">
                            <source src="${station.audio}" type="audio/mpeg">
                            Ihr Browser unterstützt das Audio-Element nicht.
                        </audio>
                    `;
                    mediaContainer.appendChild(audioDiv);
                }

                // 3D Model Button
                if (station.model3d) {
                    const modelBtn = document.createElement('button');
                    modelBtn.className = 'w-full py-2 border border-[#a67c00] text-[#a67c00] rounded hover:bg-[#a67c00] hover:text-white transition flex items-center justify-center gap-2 text-sm font-medium';
                    modelBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.5 22.37a.997.997 0 0 0 .5 0l7.5-4a1 1 0 0 0 .5-.86v-8l-8 4.25-8-4.25v8a1 1 0 0 0 .5.86l7.5 4Z"/><path d="M3 7l9-5 9 5M12 22V12"/></svg> 3D-Scan ansehen`;
                    modelBtn.onclick = () => {
                        // HIER: Logik zum Öffnen des 3D Viewers (z.B. Modal oder Link)
                        alert("Platzhalter: Hier würde sich der 3D-Viewer öffnen für Modell: " + station.model3d);
                    };
                    mediaContainer.appendChild(modelBtn);
                }

            } else {
                mediaContainer.classList.add('hidden');
            }

            document.getElementById('startNavigation').onclick = () => startRoute(station.coords);
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text; toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        function updateNavigator() {
            if (!userLocation) return;
            document.getElementById('nav-initial-state').classList.add('hidden');
            document.getElementById('nav-active-state').classList.remove('hidden');

            let nearest = null;
            let minDist = Infinity;
            stations.forEach(s => {
                const dist = L.latLng(userLocation.lat, userLocation.lng).distanceTo(L.latLng(s.coords[0], s.coords[1]));
                if (dist < minDist) { minDist = dist; nearest = s; }
            });

            if (nearest) {
                document.getElementById('nav-next-title').innerText = nearest.title;
                const distText = minDist > 1000 ? (minDist/1000).toFixed(1) + " km" : Math.round(minDist) + " m";
                document.getElementById('nav-dist').innerText = distText;
                const minutes = Math.ceil(minDist / 80);
                document.getElementById('nav-time').innerText = minutes + " Min.";
                
                // --- ARRIVAL CHECK LOGIC ---
                const statusText = document.getElementById('nav-status-text');
                
                if (minDist < 40) { // Wenn näher als 40m
                    statusText.innerHTML = `<span class="h-2 w-2 rounded-full bg-red-600 animate-pulse mr-2"></span> Ziel erreicht!`;
                    statusText.classList.remove('text-green-600');
                    statusText.classList.add('text-red-600');

                    // Wenn wir diesen Kreis noch nicht gemalt haben
                    if (!currentHighlightLayer || currentHighlightLayer._latlng.lat !== nearest.coords[0]) {
                        if (currentHighlightLayer) map.removeLayer(currentHighlightLayer);
                        
                        currentHighlightLayer = L.circle(nearest.coords, {
                            color: '#e74c3c',
                            fillColor: '#c0392b',
                            fillOpacity: 0.3,
                            radius: 35, // Größe der Zone
                            className: 'arrival-marker' // Pulsierende CSS Animation
                        }).addTo(map);
                        
                        showToast("Sie haben das Ziel erreicht!");
                    }
                } else {
                    statusText.innerHTML = `<span class="h-1.5 w-1.5 rounded-full bg-green-600 mr-1"></span> Aktiv`;
                    statusText.classList.add('text-green-600');
                    statusText.classList.remove('text-red-600');
                    
                    if (currentHighlightLayer) {
                        map.removeLayer(currentHighlightLayer);
                        currentHighlightLayer = null;
                    }
                }
            }
        }

        function startRoute(destCoords) {
            if (!userLocation) { showToast("Bitte erst GPS aktivieren."); return; }
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLocation.lat, userLocation.lng), L.latLng(destCoords[0], destCoords[1])],
                createMarker: () => null,
                language: 'de',
                lineOptions: { styles: [{ color: '#a67c00', opacity: 0.8, weight: 6 }] }
            }).addTo(map);
            showToast("Route gestartet.");
        }

        document.getElementById('locateMe').onclick = () => {
            if (!navigator.geolocation) return showToast("GPS nicht unterstützt.");
            navigator.geolocation.watchPosition((position) => {
                const { latitude, longitude } = position.coords;
                userLocation = { lat: latitude, lng: longitude };
                if (userMarker) userMarker.setLatLng([latitude, longitude]);
                else userMarker = L.circleMarker([latitude, longitude], { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map);
                document.getElementById('gps-icon').setAttribute('stroke', '#3b82f6');
                updateNavigator();
            }, () => showToast("GPS Zugriff verweigert."), { enableHighAccuracy: true });
        };

        document.getElementById('backToList').onclick = () => {
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            if (routingControl) map.removeControl(routingControl);
        };

        document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');

        window.onload = initApp;
    </script>
</body>
</html>
