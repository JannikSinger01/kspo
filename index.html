<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Map Navigator</title>
    
    <!-- Tailwind CSS für schnelles Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        
        /* Custom Styling für die Routing-Box, damit sie modern aussieht */
        .leaflet-routing-container {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            padding: 15px !important;
            border: none !important;
            font-family: system-ui, -apple-system, sans-serif !important;
        }
        
        .leaflet-bar a {
            background-color: white;
            color: #3b82f6; /* Tailwind Blue-500 */
            border-bottom: 1px solid #e5e7eb;
        }
        
        .leaflet-control-layers {
            border-radius: 8px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            border: none !important;
            padding: 6px !important;
        }

        /* Pulsierender Effekt für den eigenen Standort */
        .gps-marker {
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- UI Overlay (Titel & Buttons) -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-white/90 backdrop-blur-sm px-6 py-2 rounded-full shadow-lg border border-gray-200 flex items-center gap-3">
        <i class="fa-solid fa-map-location-dot text-blue-500 text-xl"></i>
        <h1 class="text-gray-800 font-bold text-lg">VibeNav</h1>
    </div>

    <div class="absolute bottom-8 right-4 z-[1000] flex flex-col gap-3">
        <button onclick="locateUser()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-all hover:scale-110 group tooltip" title="Mein Standort">
            <i class="fa-solid fa-location-crosshairs text-xl"></i>
        </button>
        <button onclick="clearRoute()" class="bg-red-500 hover:bg-red-600 text-white p-4 rounded-full shadow-lg transition-all hover:scale-110" title="Route löschen">
            <i class="fa-solid fa-trash text-xl"></i>
        </button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- 1. Karte initialisieren ---
        // Wir starten in Berlin als Default
        const map = L.map('map').setView([52.5200, 13.4050], 13);

        // --- 2. Layer definieren (Kartenarten) ---
        
        // A. Standard Straßenkarte (OpenStreetMap)
        const osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map); // Standardmäßig hinzufügen

        // B. Satellitenkarte (Esri World Imagery)
        // Dieser Provider ist oft frei zugänglich für Standardanwendungen
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Layer-Kontrolle hinzufügen (oben rechts)
        const baseMaps = {
            "Straßenkarte": osmLayer,
            "Satellit": satelliteLayer
        };
        L.control.layers(baseMaps).addTo(map);

        // --- 3. Routing Setup ---
        let routingControl = null;

        function initRouting(startLat, startLng, destLat, destLng) {
            // Wenn schon eine Route da ist, entferne sie zuerst
            if (routingControl) {
                map.removeControl(routingControl);
            }

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(startLat, startLng),
                    L.latLng(destLat, destLng)
                ],
                routeWhileDragging: true,
                language: 'de', // Deutsche Anweisungen
                showAlternatives: true,
                lineOptions: {
                    styles: [{color: '#3b82f6', opacity: 0.7, weight: 6}]
                },
                createMarker: function(i, wp, nWps) {
                    // Custom Marker Icons (Start = Grün, Ziel = Rot)
                    const color = i === 0 ? 'green' : (i === nWps - 1 ? 'red' : 'blue');
                    return L.marker(wp.latLng, {
                        icon: L.divIcon({
                            className: 'custom-pin',
                            html: `<i class="fa-solid fa-location-dot" style="color: ${color}; font-size: 32px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); transform: translate(-50%, -100%);"></i>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    });
                }
            }).addTo(map);
        }

        // Demo-Route initialisieren (Berlin Hbf -> Brandenburger Tor)
        initRouting(52.5251, 13.3694, 52.5163, 13.3777);

        // --- 4. Interaktion: Klick auf Karte für Wegpunkte ---
        // Einfache Logik: Klick setzt neues Ziel, aktueller Center oder GPS ist Start
        map.on('click', function(e) {
            const dest = e.latlng;
            
            // Wir nehmen als Startpunkt den ersten Wegpunkt der aktuellen Route 
            // oder den Center der Karte, wenn noch keine Route da ist.
            let start = map.getCenter();
            if (routingControl && routingControl.getWaypoints().length > 0) {
                start = routingControl.getWaypoints()[0].latLng;
            }

            initRouting(start.lat, start.lng, dest.lat, dest.lng);
        });

        // --- 5. GPS / Geolocation ---
        let userMarker = null;

        function locateUser() {
            if (!navigator.geolocation) {
                alert("Geolocation wird von diesem Browser nicht unterstützt.");
                return;
            }

            // Lade-Feedback (Icon dreht sich)
            const icon = document.querySelector('.fa-location-crosshairs');
            icon.classList.add('fa-spin');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Marker entfernen falls vorhanden
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    // Custom GPS Marker (CSS pulse)
                    const gpsIcon = L.divIcon({
                        className: 'gps-marker-wrapper',
                        html: '<div class="gps-marker"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    userMarker = L.marker([lat, lng], {icon: gpsIcon}).addTo(map);
                    
                    // Karte zentrieren und zoomen
                    map.flyTo([lat, lng], 16);
                    
                    // Routing vom aktuellen Standort starten (optional)
                    // Wenn es schon ein Ziel gibt, aktualisiere den Startpunkt
                    if (routingControl) {
                        const waypoints = routingControl.getWaypoints();
                        const dest = waypoints[waypoints.length - 1].latLng;
                        initRouting(lat, lng, dest.lat, dest.lng);
                    }

                    // Lade-Animation stoppen
                    icon.classList.remove('fa-spin');
                },
                (error) => {
                    alert("Standort konnte nicht ermittelt werden: " + error.message);
                    icon.classList.remove('fa-spin');
                }
            );
        }

        function clearRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
        }
    </script>
</body>
</html>
