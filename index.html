<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koloniale Spuren Osnabrück | Digitale Stadtführung</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;600&display=swap');

        :root {
            --vintage-paper: #f4f1ea;
            --charcoal: #2d3436;
            --accent-gold: #a67c00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--vintage-paper);
            color: var(--charcoal);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1, h2, h3, .font-serif { font-family: 'Crimson Pro', serif; }

        #map { flex-grow: 1; z-index: 1; }

        .custom-popup .leaflet-popup-content-wrapper {
            background: var(--vintage-paper);
            color: var(--charcoal);
            border-radius: 4px;
            border: 1px solid var(--accent-gold);
        }

        .sidebar { transition: transform 0.3s ease-in-out; z-index: 1000; }

        .station-card:hover {
            border-left: 4px solid var(--accent-gold);
            background: rgba(166, 124, 0, 0.05);
        }

        .leaflet-control-layers {
            border-radius: 8px !important;
            border: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        /* Versteckt die Text-Anweisungen der Route für saubere Screenshots */
        .leaflet-routing-container { display: none !important; }

        /* Navigator Panel Styling */
        #navigator-panel {
            z-index: 1000;
        }

        #nav-info-card {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(8px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Intro Overlay Animation */
        #intro-overlay {
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }
        #intro-overlay.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        /* Animation für den Hinweis-Pfeil */
        @keyframes bounce-up-down {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(6px); }
        }
        .animate-bounce-slow {
            animation: bounce-up-down 1.5s infinite ease-in-out;
        }
        
        .intro-frame {
            border: 1px solid rgba(166, 124, 0, 0.3);
            pointer-events: none;
        }

        /* --- TUTORIAL STYLES --- */
        #tutorial-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9000;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        #tutorial-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #tutorial-spotlight {
            position: absolute;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 8px;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            pointer-events: none;
        }

        #tutorial-tooltip {
            position: absolute;
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            pointer-events: auto;
            transition: all 0.4s ease;
            z-index: 9002;
        }

        /* --- ALLGEMEINES MODAL STYLING (für Literatur & Stationen) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(45, 52, 54, 0.85);
            backdrop-filter: blur(4px);
            z-index: 8000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--vintage-paper);
            width: 95%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0; 
            border-radius: 8px;
            border: 1px solid var(--accent-gold);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            position: relative;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* SPEZIALSTYLES FÜR STATION MODAL (Verschiebbar) */
        #station-overlay {
            background: none !important; /* Kein dunkler Hintergrund */
            backdrop-filter: none !important;
            pointer-events: none; /* Klicks gehen durch den leeren Bereich durch */
        }
        
        #station-overlay .modal-content {
            pointer-events: auto; /* Box selbst ist klickbar */
            position: absolute; /* Wichtig für Drag & Drop */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Startzentrierung */
            margin: 0;
            /* Der gewünschte dünne Rahmen + Schatten */
            box-shadow: 0 0 0 2px #fff, 0 0 0 3px var(--accent-gold), 0 15px 40px rgba(0,0,0,0.4);
            border: none;
        }

        /* --- STYLES FÜR BILDER IM FLIESSTEXT --- */
        #modal-content-text img {
            margin: 1.5rem 0;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e5e5e5;
            width: 100%;
            height: auto;
            display: block;
        }
        #modal-content-text figure {
            margin: 2rem 0;
        }
        #modal-content-text figcaption {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 0.5rem;
            font-family: 'Inter', sans-serif;
            font-style: italic;
        }

        .modal-drag-handle {
            height: 32px;
            background: #fdfcf9;
            border-bottom: 1px solid #e5e5e5;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px 8px 0 0;
            color: #ccc;
        }
        .modal-drag-handle:hover {
            background: #f4f1ea;
            color: var(--accent-gold);
        }
        
        .modal-close-btn {
            position: absolute;
            top: 5px; 
            right: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            padding: 4px;
            z-index: 20;
            cursor: pointer;
            transition: background 0.2s;
            color: #555;
        }
        .modal-close-btn:hover {
            background: white;
            color: #000;
        }

        /* Arrival Prompt Styling */
        #arrival-prompt {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #arrival-prompt.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Pulse Animation für Zielzone */
        @keyframes pulse-red {
            0% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 0.4; transform: scale(0.8); }
        }
        .arrival-marker {
            animation: pulse-red 2s infinite;
        }

        /* --- MARKER STYLES --- */
        .number-icon {
            background-color: #fdfcf9;
            color: #2d3436;
            border: 2px solid #a67c00;
            border-radius: 50%;
            text-align: center;
            line-height: 30px; 
            font-family: 'Crimson Pro', serif;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        .number-icon:hover {
            transform: scale(1.15);
            background-color: #a67c00;
            color: #fff;
            border-color: #a67c00;
            box-shadow: 0 6px 12px rgba(166, 124, 0, 0.3);
        }

        /* Styling für Audio Player */
        audio::-webkit-media-controls-panel {
            background-color: #f4f1ea;
        }

        /* Fullscreen Image Overlay */
        #fullscreen-overlay {
            transition: opacity 0.3s ease-in-out, visibility 0.3s;
        }
        #fullscreen-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            display: flex !important; /* Keep flex for centering, just hide vis */
            pointer-events: none;
        }
        #fullscreen-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <!-- LITERATUR MODAL (Bleibt Standard) -->
    <div id="lit-overlay" class="modal-overlay">
        <div class="modal-content p-8 relative">
            <button id="closeLit" class="modal-close-btn" style="top: 15px; right: 15px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <h2 class="text-2xl font-serif border-b border-[#a67c00] pb-2 mb-6 text-[#2d3436]">Literatur & Quellen</h2>
            
            <div class="space-y-6 text-sm text-gray-700 font-light leading-relaxed">
                <p class="italic text-xs text-gray-500 mb-4">Verwendete Literatur für dieses Projekt.</p>
                
                <!-- NEU EINGEFÜGT: Gröpl -->
                <div class="pl-4 border-l-2 border-gray-300">
                    <p>Gröpl, Myriam. Repräsentationen des Anderen – Museen und Völkerschauen. URL: https://geschichtsbuch.hamburg.de/epochen/kolonialismus/577-2/ [zuletzt aufgerufen am 13.01.2026].</p>
                </div>

                <div class="pl-4 border-l-2 border-gray-300">
                    <p>Heyden, Ulrich van der; Zeller, Joachim (Hrsg.). Kolonialismus hierzulande. 2007. Erfurt. Sutton Verlag.</p>
                </div>
                 <div class="pl-4 border-l-2 border-gray-300">
                    <p>Hoffmeyer, Ludwig. Chronik der Stadt Osnabrück. 1982. Vierte Auflage. Osnabrück. Druck und Verlag Meinders&Elstermann. S. 96ff.</p>
                </div>
                 <div class="pl-4 border-l-2 border-gray-300">
                    <p>Ismard, Paulin (Hrsg.). Welten der Sklaverei. 2023. Berlin. Verlagshaus Jacoby&Stuart.</p>
                </div>
                 <div class="pl-4 border-l-2 border-gray-300">
                    <p>Kühling, Karl. Die Juden in Osnabrück. 1983. Osnabrück. T.H. Wenner Verlag.</p>
                </div>
                 <div class="pl-4 border-l-2 border-gray-300">
                    <p>Schipmann, Johannes Ludwig. Osnabrück und die Hanse. 2006. Bramsche. Rasch Verlag. S. 69.</p>
                </div>
                 <div class="pl-4 border-l-2 border-gray-300">
                    <p>Wagner, Gisela. Osnabrück als Stadt der Hanse. 1980. Osnabrück. Selbstverlag des Vereins für Geschichte und Landeskunde.</p>
                </div>
                 <div class="pl-4 border-l-2 border-gray-300">
                    <p>Weipert, Matthias; Groth, Daniel; Fenske, Uta (Hrsg.). Grenzgang. Grenzgängerinnen. Grenzgänger. 2017. Mörlenbach. Röhrig Universitätsverlag.</p>
                </div>
                
                <div class="mt-8 pt-4 border-t border-gray-200 text-xs text-gray-400">
                    <p>Alle Rechte vorbehalten.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- STATION DETAIL MODAL (DRAGGABLE) -->
    <div id="station-overlay" class="modal-overlay">
        <div id="station-modal-content" class="modal-content">
            <!-- DRAG HANDLE -->
            <div id="station-drag-handle" class="modal-drag-handle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </div>

            <button id="closeStation" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <!-- Bild-Container (Hauptbild) -->
            <div id="modal-image-container" class="w-full bg-[#e5e5e5] relative flex justify-center items-center min-h-[200px] cursor-zoom-in group" title="Klicken für Vollbild">
                <!-- Bild kommt hier rein -->
            </div>
            
            <!-- Bildnachweis / Copyright -->
            <div id="modal-image-copyright" class="w-full px-4 py-1 bg-gray-50 text-[10px] text-gray-500 text-right italic hidden border-b border-gray-100"></div>

            <div class="p-8">
                <h2 id="modal-title" class="text-3xl font-serif text-[#2d3436] mb-4"></h2>
                
                <!-- Multimedia Sektion -->
                <div id="modal-media" class="mb-6 hidden bg-white p-4 rounded border border-gray-200 shadow-sm">
                    <!-- Audio & 3D kommen hier rein -->
                </div>

                <div id="modal-content-text" class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-4">
                    <!-- Text kommt hier rein -->
                </div>

                <!-- Footer Navigation im Modal -->
                <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col gap-3">
                    
                    <!-- Next Station Button -->
                    <button id="modal-next-btn" class="w-full bg-[#a67c00] text-white py-3 rounded-lg flex justify-center items-center hover:bg-[#856300] transition group font-bold">
                        <span>Zur nächsten Station</span>
                        <svg class="ml-2 group-hover:translate-x-1 transition-transform" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>

                    <!-- Start Navigation to THIS station -->
                    <button id="modal-navigate-btn" class="w-full bg-[#fdfcf9] border border-gray-300 text-charcoal py-2 rounded-lg flex justify-center items-center hover:bg-gray-50 transition text-sm">
                        <svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                        Navigation hierher starten
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FULLSCREEN IMAGE OVERLAY -->
    <div id="fullscreen-overlay" class="fixed inset-0 z-[9999] bg-black hidden flex justify-center items-center">
        <button id="closeFullscreen" class="absolute top-6 left-6 text-white bg-black/50 px-4 py-2 rounded-full hover:bg-white/20 transition flex items-center gap-2 backdrop-blur-sm border border-white/30 font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Zurück
        </button>
        <img id="fullscreen-image" src="" alt="Vollbild" class="max-w-full max-h-full object-contain p-4">
    </div>

    <!-- TUTORIAL OVERLAY -->
    <div id="tutorial-overlay">
        <div id="tutorial-spotlight"></div>
        <div id="tutorial-tooltip">
            <h4 id="tut-title" class="text-[#a67c00] font-bold uppercase text-xs tracking-wider mb-2">Schritt 1</h4>
            <p id="tut-text" class="text-charcoal text-sm leading-relaxed mb-4">Erklärungstext hier.</p>
            <div class="flex justify-between items-center border-t border-gray-100 pt-3">
                <button id="tut-skip" class="text-xs text-gray-400 hover:text-gray-600">Überspringen</button>
                <button id="tut-next" class="bg-[#2d3436] text-white text-xs px-4 py-2 rounded hover:bg-[#a67c00] transition-colors">Weiter</button>
            </div>
        </div>
    </div>

    <!-- ARRIVAL PROMPT -->
    <div id="arrival-prompt" class="fixed bottom-24 right-6 bg-white p-4 rounded-xl shadow-2xl border-l-4 border-[#a67c00] z-[2000] hidden transform translate-y-10 opacity-0 w-72">
        <div class="flex justify-between items-start">
            <div>
                <h4 class="font-bold text-[#2d3436] text-sm uppercase tracking-wide">Station erreicht!</h4>
                <p id="arrival-station-name" class="text-xs text-gray-600 mt-1 mb-3 font-serif italic text-lg leading-tight">Station Name</p>
            </div>
            <button id="closeArrival" class="text-gray-400 hover:text-gray-600 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <button id="openArrival" class="w-full bg-[#a67c00] hover:bg-[#856300] text-white text-sm font-medium py-2 rounded shadow-sm transition flex items-center justify-center gap-2">
            Inhalt ansehen 
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h10"/><path d="M9 4v16"/><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg>
        </button>
    </div>

    <!-- Full Screen Intro Overlay -->
    <div id="intro-overlay" class="fixed inset-0 z-[5000] bg-[#f4f1ea] flex flex-col justify-center items-center overflow-y-auto">
        <div class="absolute inset-4 intro-frame z-0"></div>
        <div class="absolute inset-6 intro-frame z-0"></div>

        <div class="relative z-10 max-w-7xl w-full px-8 md:px-12 py-12 flex flex-col md:flex-row gap-8 lg:gap-16 items-center h-full justify-center">
            <div class="md:w-1/3 text-center md:text-left space-y-6">
                <div class="inline-block border-b-2 border-[#a67c00] pb-2 mb-2">
                    <span class="text-[#a67c00] text-sm font-bold uppercase tracking-[0.25em]">Universität Osnabrück</span>
                </div>
                <h1 class="text-5xl md:text-6xl lg:text-7xl font-serif text-[#2d3436] leading-[1.1]">
                    Koloniale<br><span class="italic text-[#a67c00]">Spuren</span><br>Osnabrück
                </h1>
                <p class="text-base text-gray-500 font-light italic max-w-sm">
                    Eine digitale Kartierung historischer Verflechtungen, Handelswege und Erinnerungskultur.
                </p>
            </div>
            <div class="md:w-2/3 w-full space-y-8 bg-white/60 backdrop-blur-md p-10 md:p-12 border-l-4 border-[#a67c00] shadow-sm rounded-r-lg">
                <div class="prose prose-lg md:prose-xl text-gray-700 leading-relaxed font-serif max-w-none">
                    <p><strong class="text-[#2d3436]">Willkommen zur digitalen Spurensuche.</strong><br>Osnabrück wirkt auf den ersten Blick weit entfernt von der deutschen Kolonialgeschichte. Doch der Schein trügt.</p>
                    <p>Diese Web-App macht die unsichtbaren Verbindungen sichtbar: Wir beleuchten Biografien von Akteuren, die vom Überseehandel profitierten, und untersuchen Denkmäler im Stadtbild.</p>
                    <p class="text-base italic text-gray-500 mt-4 border-t border-gray-200 pt-4">Nutzen Sie den interaktiven Navigator (unten rechts), um die Stationen vor Ort via GPS zu finden, oder erkunden Sie die historischen Hintergründe bequem von zu Hause aus.</p>
                </div>
                <div class="pt-4">
                    <button id="closeIntro" class="group w-full md:w-auto bg-[#2d3436] text-white px-8 py-4 text-lg font-medium tracking-wide hover:bg-[#a67c00] transition-colors duration-300 flex items-center justify-center md:justify-start gap-4 shadow-lg rounded-sm">
                        <span>Rundgang beginnen</span>
                        <svg class="transform group-hover:translate-x-2 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>
                    <p class="text-[10px] text-gray-400 mt-4 uppercase tracking-wider">Version Web-App-Slam</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header id="main-header" class="bg-[#2d3436] text-white p-4 shadow-md flex justify-between items-center relative z-[1001]">
        <div>
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight font-serif">Koloniale Spurensuche in Osnabrück</h1>
        </div>
        <div class="flex items-center gap-4">
            <button id="openLit" class="text-xs md:text-sm text-gray-300 hover:text-[#a67c00] hover:bg-white/10 px-3 py-1 rounded transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <span class="hidden md:inline decoration-dotted underline underline-offset-4">Hier gehts zur Literaturliste</span>
                <span class="md:hidden">Literatur</span>
            </button>
            <button id="toggleSidebar" class="md:hidden bg-accent-gold p-2 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </header>

    <main class="flex flex-1 relative overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar absolute md:relative w-full md:w-96 bg-[#fdfcf9] border-r border-gray-200 h-full overflow-y-auto transform -translate-x-full md:translate-x-0 shadow-xl">
            <div class="p-6">
                <div id="intro-view">
                    <h2 class="text-2xl mb-4 border-b border-gray-200 pb-2 font-serif">Stationen der Tour</h2>
                    <p class="text-sm text-gray-600 mb-6">Wählen Sie einen Ort, um mehr über koloniale Verflechtungen zu erfahren.</p>
                    <div id="station-list" class="space-y-4"></div>
                </div>
            </div>
        </aside>

        <!-- Map -->
        <div id="map"></div>

        <!-- Navigator Overlay -->
        <div id="navigator-panel" class="absolute bottom-6 right-6 flex flex-col items-end gap-3 pointer-events-none">
            <div id="nav-info-card" class="bg-white/95 p-4 rounded-xl border border-gray-200 w-64 md:w-72 pointer-events-auto shadow-2xl">
                <div id="nav-initial-state">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] uppercase tracking-widest text-accent-gold font-bold italic">Navigator</span>
                        <div class="h-2 w-2 rounded-full bg-red-500 animate-pulse"></div>
                    </div>
                    <h4 class="text-sm font-bold text-charcoal">Routenplaner</h4>
                    <p class="text-[11px] text-gray-500 mt-1 leading-snug">Aktivieren Sie Ihren Standort, um Entfernungen und Gehzeiten zu den Stationen zu sehen.</p>
                    <div class="flex justify-end pr-4 mt-4">
                        <svg class="animate-bounce-slow text-accent-gold" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
                    </div>
                </div>
                <div id="nav-active-state" class="hidden">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] uppercase tracking-widest text-accent-gold font-bold">Nächste Station</span>
                        <span id="nav-dist" class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">-- m</span>
                    </div>
                    <h4 id="nav-next-title" class="text-sm font-bold truncate">Berechne...</h4>
                    <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-gray-100">
                        <div>
                            <p class="text-[9px] text-gray-400 uppercase">Gehzeit ca.</p>
                            <p id="nav-time" class="text-sm font-semibold text-charcoal">-- Min.</p>
                        </div>
                        <div>
                            <p class="text-[9px] text-gray-400 uppercase">Status</p>
                            <p id="nav-status-text" class="text-sm font-semibold text-green-600 flex items-center">
                                <span class="h-1.5 w-1.5 rounded-full bg-green-600 mr-1"></span> Aktiv
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <button id="locateMe" class="bg-white p-4 rounded-full shadow-lg border border-gray-100 hover:bg-gray-50 active:scale-90 transition-all pointer-events-auto group relative">
                <span class="absolute -top-12 right-0 bg-charcoal text-white text-[10px] py-1 px-3 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">GPS aktivieren</span>
                <svg id="gps-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a67c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="22"></line><line x1="2" y1="12" x2="4" y2="12"></line><line x1="20" y1="12" x2="22" y2="12"></line></svg>
            </button>
        </div>
    </main>

    <div id="toast" class="fixed bottom-32 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-2 rounded-full text-xs opacity-0 transition-opacity z-[2000] pointer-events-none shadow-2xl">
        Standort wird abgerufen...
    </div>

    <script>
        // DRAG FUNKTION (Verschiebbarkeit)
        function makeDraggable(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            if (document.getElementById("station-drag-handle")) {
                // If present, the header is where you move the DIV from:
                document.getElementById("station-drag-handle").onmousedown = dragMouseDown;
            } else {
                // Otherwise, move the DIV from anywhere inside the DIV:
                elmnt.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // Get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Wichtig: Beim ersten Drag entfernen wir den Transform, um Sprünge zu vermeiden
                // und setzen fixe Top/Left Werte
                const style = window.getComputedStyle(elmnt);
                const matrix = new WebKitCSSMatrix(style.transform);
                
                // Falls noch zentriert durch transform, rechnen wir das um
                if(style.transform !== 'none') {
                   // Das Element ist bereits positioniert durch CSS Top 50% Left 50%
                   // Wir lassen es dort, aber entfernen den Transform und setzen Margins um es zu halten
                   // Einfacher: Wir nutzen einfach offsetTop/Left
                   elmnt.style.left = elmnt.offsetLeft + "px";
                   elmnt.style.top = elmnt.offsetTop + "px";
                   elmnt.style.transform = "none"; 
                }

                document.onmouseup = closeDragElement;
                // Call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // Calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // Set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                // Stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        const stations = [
            {
                id: 0,
                title: "Start: So funktioniert der Rundgang",
                coords: [52.2770, 8.0420], 
                short: "Anleitung und Funktionen.",
                image: "images/intro.jpg",
                imageCopyright: "",
                content: `
                    <h3 class="font-bold text-lg mb-2">Herzlich Willkommen!</h3>
                    <p>Dieser digitale Stadtrundgang führt Sie zu den Spuren der kolonialen Vergangenheit in Osnabrück.</p>
                    
                    <h4 class="font-bold mt-4">So nutzen Sie die App:</h4>
                    <ul class="list-disc pl-5 mt-2 space-y-1">
                        <li><strong>Orientierung:</strong> Die Bilder in der App helfen Ihnen, die Orte im heutigen Stadtbild wiederzuerkennen.</li>
                        <li><strong>Audio-Guide:</strong> Sie möchten lieber hören statt lesen? Nutzen Sie den Audio-Player in jedem Fenster.</li>
                        <li><strong>3D-Scans:</strong> Bei ausgewählten Stationen können Sie digitale 3D-Modelle der Objekte betrachten.</li>
                        <li><strong>Flexibler Start:</strong> Sie können an jeder Station beginnen. Der <strong>Navigator</strong> (unten rechts) zeigt Ihnen immer den Weg zum nächstgelegenen Ziel.</li>
                    </ul>
                `,
                audio: "audio/intro.mp3",
                model3d: ""
            },
            { 
                id: 1, 
                title: "Station I: Der Domplatz", 
                coords: [52.27753, 8.04405], 
                short: "Vorplatz des Doms.", 
                image: "images/dom.jpg",
                imageCopyright: "Rolf Kranz",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Historischer Hintergrund</h3>
                    <p>[Platzhalter: Beschreiben Sie hier die Bedeutung des Domplatzes im Mittelalter und der Frühen Neuzeit.]</p>
                    
                    <h3 class="font-bold text-lg mt-4 mb-2">Koloniale Spuren</h3>
                    <p>[Platzhalter: Welche Verbindungen gibt es hier? Gedenktafeln, Gebäude von Kaufleuten oder Veranstaltungen?]</p>
                `,
                audio: "audio/station1.mp3", 
                model3d: "" 
            },
            { 
                id: 2, 
                title: "Station II: Die Marienkirche", 
                coords: [52.27763, 8.04172], 
                short: "Marktplatz und Kirche.", 
                image: "images/marienkirche.jpg",
                imageCopyright: "Quersus",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Historischer Hintergrund</h3>
                    <p>[Platzhalter: Die Rolle der Marienkirche als Bürgerkirche am Markt.]</p>
                    
                    <h3 class="font-bold text-lg mt-4 mb-2">Koloniale Spuren</h3>
                    <p>[Platzhalter: Gibt es hier Grabmäler oder Spendenhinweise von kolonialen Akteuren?]</p>
                `,
                audio: "audio/station2.mp3", 
                model3d: "" 
            },
            { 
                id: 3, 
                title: "Station III: Das Heger Tor", 
                coords: [52.27623, 8.03881], 
                short: "Erinnerungsort.", 
                image: "images/tor.jpg",
                imageCopyright: "J.-H. Janßen",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Das Bauwerk</h3>
                    <p>[Platzhalter: Baugeschichte des Heger Tors / Waterloo-Tors.]</p>
                    
                    <h3 class="font-bold text-lg mt-4 mb-2">Kritische Einordnung</h3>
                    <p>[Platzhalter: Wie wird hier Krieg und Heldentum dargestellt? Welcher Bezug besteht zu imperialen Kriegen?]</p>
                `,
                audio: "audio/station3.mp3", 
                model3d: "hegertor_scan" 
            },
            { 
                id: 4, 
                title: "Station IV: Museum und Kolonialismus", 
                coords: [52.27554, 8.03890], 
                short: "Museumsquartier.", 
                image: "images/museum.jpg",
                imageCopyright: "Axel Hindemith",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Das Museumsquartier</h3>
                    <p>[Platzhalter: Kurze Vorstellung des Museumsstandorts.]</p>
                    
                    <h3 class="font-bold text-lg mt-4 mb-2">Sammlungsgeschichte</h3>
                    <p>[Platzhalter: Wie geht das Museum heute mit Objekten aus kolonialen Kontexten um?]</p>
                `,
                audio: "audio/station4.mp3", 
                model3d: "" 
            },
            { 
                id: 5, 
                title: "Station V: Menschenschau", 
                coords: [52.27084, 8.04301], 
                short: "Völkerschauen in Osnabrück.", 
                image: "images/station5.jpg",
                imageCopyright: "",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Ort des Geschehens</h3>
                    <p>Hier an diesem Ort fanden im späten 19. und frühen 20. Jahrhundert Veranstaltungen statt, die heute als "Völkerschauen" bekannt sind. Menschen aus fernen Regionen wurden hier wie Exponate zur Schau gestellt.</p>
                    
                    <!-- BILD 1 -->
                    <figure class="my-8 p-2 bg-gray-50 rounded border border-gray-100">
                        <!-- HIER DEIN BILD EINFÜGEN: Ersetze den src-Link -->
                        <img src="https://placehold.co/600x400/e2e8f0/475569?text=Platzhalter+Bild+1+(Grafik)" alt="Historische Grafik" class="mb-2 w-full h-auto rounded shadow-sm" />
                        <figcaption>
                            <div class="text-[10px] uppercase tracking-wider text-gray-400 font-bold border-b border-gray-200 pb-1 mb-1">Quelle: [Name des Urhebers / Archiv]</div>
                            <div class="text-sm italic text-gray-700">Bildunterschrift 1: Beschreiben Sie hier, was auf dem ersten Bild zu sehen ist und ordnen Sie es historisch ein.</div>
                        </figcaption>
                    </figure>

                    <h3 class="font-bold text-lg mt-4 mb-2">Hintergrund der 'Völkerschauen'</h3>
                    <p>Diese Schauen dienten der Unterhaltung, transportierten aber gleichzeitig ein rassistisches Weltbild. Sie suggerierten eine Überlegenheit der europäischen Zuschauer gegenüber den "exotischen" Darstellern.</p>

                    <!-- BILD 2 -->
                    <figure class="my-8 p-2 bg-gray-50 rounded border border-gray-100">
                        <img src="https://placehold.co/600x400/e2e8f0/475569?text=Platzhalter+Bild+2" alt="Platzhalter 2" class="mb-2 w-full h-auto rounded shadow-sm" />
                        <figcaption>
                            <div class="text-[10px] uppercase tracking-wider text-gray-400 font-bold border-b border-gray-200 pb-1 mb-1">Quelle: [Name des Urhebers / Archiv]</div>
                            <div class="text-sm italic text-gray-700">Bildunterschrift 2: Kontextualisierung für das zweite Bild.</div>
                        </figcaption>
                    </figure>

                    <p>Oft wurden die Menschen in konstruierten "Dörfern" präsentiert, die wenig mit ihrer tatsächlichen Lebensrealität zu tun hatten, sondern europäische Klischees bedienten.</p>

                    <!-- BILD 3 -->
                    <figure class="my-8 p-2 bg-gray-50 rounded border border-gray-100">
                        <img src="https://placehold.co/600x400/e2e8f0/475569?text=Platzhalter+Bild+3" alt="Platzhalter 3" class="mb-2 w-full h-auto rounded shadow-sm" />
                        <figcaption>
                            <div class="text-[10px] uppercase tracking-wider text-gray-400 font-bold border-b border-gray-200 pb-1 mb-1">Quelle: [Name des Urhebers / Archiv]</div>
                            <div class="text-sm italic text-gray-700">Bildunterschrift 3: Weitere Details oder historische Einordnung.</div>
                        </figcaption>
                    </figure>

                    <!-- BILD 4 -->
                    <figure class="my-8 p-2 bg-gray-50 rounded border border-gray-100">
                        <img src="https://placehold.co/600x400/e2e8f0/475569?text=Platzhalter+Bild+4" alt="Platzhalter 4" class="mb-2 w-full h-auto rounded shadow-sm" />
                        <figcaption>
                            <div class="text-[10px] uppercase tracking-wider text-gray-400 font-bold border-b border-gray-200 pb-1 mb-1">Quelle: [Name des Urhebers / Archiv]</div>
                            <div class="text-sm italic text-gray-700">Bildunterschrift 4: Abschlussbild oder heutige Perspektive.</div>
                        </figcaption>
                    </figure>
                `,
                audio: "audio/station5.mp3", 
                model3d: "" 
            },
            { 
                id: 6, 
                title: "Station VI: Die Erdteilallegorien", 
                coords: [52.27107, 8.04422], 
                short: "Symbolik im Schlossgarten.", 
                image: "images/station6.jpg",
                imageCopyright: "",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Die Skulpturen</h3>
                    <p>[Platzhalter: Beschreibung der vier Figuren im Schlossgarten.]</p>
                    
                    <h3 class="font-bold text-lg mt-4 mb-2">Koloniale Ikonografie</h3>
                    <p>[Platzhalter: Analyse der Darstellung von Afrika, Asien, Amerika und Europa. Welche Stereotype werden bedient?]</p>
                `,
                audio: "audio/station6.mp3", 
                model3d: "erdteil_scan" 
            },
            { 
                id: 7, 
                title: "Station VII: Kolonialläden", 
                coords: [52.27455, 8.04694], 
                short: "Handel am Neumarkt.", 
                image: "images/station7.jpg",
                imageCopyright: "",
                
                content: `
                    <h3 class="font-bold text-lg mb-2">Handelsplatz Neumarkt</h3>
                    <p>[Platzhalter: Die Bedeutung des Neumarkts für den Einzelhandel.]</p>
                    
                    <h3 class="font-bold text-lg mt-4 mb-2">Kolonialwaren im Alltag</h3>
                    <p>[Platzhalter: Welche Produkte wurden hier verkauft? Wie warb man damals für Kaffee, Tee oder Tabak?]</p>
                `,
                audio: "audio/station7.mp3", 
                model3d: "" 
            }
        ];

        const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });

        const map = L.map('map', { zoomControl: false, layers: [lightLayer] }).setView([52.277, 8.042], 15);
        L.control.layers({ "Archiv": lightLayer, "Satellit": satelliteLayer }, null, { position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        let userLocation = null;
        let routingControl = null;
        let userMarker = null;
        let currentHighlightLayer = null; 
        let lastTriggeredStationId = null; 

        // --- TUTORIAL LOGIK ---
        let currentStepIndex = 0;
        const tutorialSteps = [
            {
                elementId: 'sidebar', // Desktop Ziel
                altElementId: 'toggleSidebar', // Mobile Ziel
                title: 'Historische Stationen',
                text: 'Hier finden Sie alle Orte der Tour. Wählen Sie einen Eintrag aus, um mehr über die Geschichte und kolonialen Hintergründe zu erfahren.'
            },
            {
                elementId: 'map', 
                title: 'Interaktive Karte',
                text: 'Die Karte zeigt Ihnen die Standorte im heutigen Stadtbild. Sie können zoomen und die Marker anklicken.'
            },
            {
                selector: '.leaflet-control-layers',
                title: 'Zeitreise-Ansicht',
                text: 'Wechseln Sie hier oben rechts zwischen der reduzierten Archiv-Karte und aktuellen Satellitenbildern.'
            },
            {
                elementId: 'navigator-panel',
                title: 'GPS-Navigator',
                text: 'Starten Sie hier den Tour-Modus. Sobald Sie Ihr GPS aktivieren, zeigen wir Ihnen den Weg und die Entfernung zur nächsten Station.'
            }
        ];

        function startTutorial() {
            document.getElementById('tutorial-overlay').classList.add('active');
            currentStepIndex = 0;
            renderTutorialStep();
        }

        function endTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
        }

        function renderTutorialStep() {
            const step = tutorialSteps[currentStepIndex];
            const spotlight = document.getElementById('tutorial-spotlight');
            const tooltip = document.getElementById('tutorial-tooltip');
            
            let target = null;
            if (step.elementId) target = document.getElementById(step.elementId);
            if (step.selector) target = document.querySelector(step.selector);
            
            const isMobile = window.innerWidth < 768;
            if (isMobile && step.altElementId) {
                target = document.getElementById(step.altElementId);
            }

            if (!target) {
                console.error("Tutorial target not found", step);
                endTutorial();
                return;
            }

            const rect = target.getBoundingClientRect();
            
            spotlight.style.width = rect.width + 'px';
            spotlight.style.height = rect.height + 'px';
            spotlight.style.top = rect.top + 'px';
            spotlight.style.left = rect.left + 'px';

            document.getElementById('tut-title').innerText = step.title;
            document.getElementById('tut-text').innerText = step.text;
            
            const nextBtn = document.getElementById('tut-next');
            nextBtn.innerText = (currentStepIndex === tutorialSteps.length - 1) ? "Starten" : "Weiter";

            const tooltipWidth = 340; 
            const tooltipHeight = 200; 
            let top = rect.top;
            let left = rect.right + 20;

            if (left + tooltipWidth > window.innerWidth) {
                left = rect.left - tooltipWidth - 20;
                if (left < 0) {
                    left = 20;
                    if (rect.bottom + tooltipHeight < window.innerHeight) {
                        top = rect.bottom + 20;
                    } else {
                        top = rect.top - tooltipHeight - 20;
                    }
                }
            }
            if (top < 10) top = 10;
            if (top + tooltipHeight > window.innerHeight) top = window.innerHeight - tooltipHeight - 20;

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        document.getElementById('tut-next').onclick = () => {
            if (currentStepIndex < tutorialSteps.length - 1) {
                currentStepIndex++;
                renderTutorialStep();
            } else {
                endTutorial();
            }
        };
        document.getElementById('tut-skip').onclick = endTutorial;


        // --- INIT & LOGIC ---

        function initApp() {
            // Overlay Logic
            document.getElementById('openLit').onclick = () => document.getElementById('lit-overlay').classList.add('active');
            document.getElementById('closeLit').onclick = () => document.getElementById('lit-overlay').classList.remove('active');
            
            document.getElementById('closeStation').onclick = () => document.getElementById('station-overlay').classList.remove('active');

            // FULLSCREEN LOGIC
            document.getElementById('closeFullscreen').onclick = () => {
                document.getElementById('fullscreen-overlay').classList.add('hidden');
            };

            // Arrival Prompt Logic
            document.getElementById('closeArrival').onclick = () => {
                document.getElementById('arrival-prompt').classList.remove('visible');
                // Temporarily disable auto-trigger to avoid spamming
                setTimeout(() => { lastTriggeredStationId = null; }, 60000); 
            };

            // Nur Lit Overlay soll bei Klick außen schließen
            document.getElementById('lit-overlay').addEventListener('click', function(e) {
                if(e.target === this) this.classList.remove('active');
            });
            // Station Overlay nicht, damit man die Karte bedienen kann. Nur X Button schließt.

            document.getElementById('closeIntro').onclick = () => {
                document.getElementById('intro-overlay').classList.add('fade-out');
                setTimeout(() => startTutorial(), 600);
            };

            const listContainer = document.getElementById('station-list');
            stations.forEach(station => {
                
                // MARKER LOGIC: Nur für Stationen mit ID > 0
                if (station.id !== 0) {
                    const icon = L.divIcon({
                        className: 'number-icon',
                        html: station.id,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                        popupAnchor: [0, -20]
                    });

                    // FINAL: Draggable deaktiviert
                    const marker = L.marker(station.coords, { icon: icon, draggable: false }).addTo(map);
                    
                    marker.on('click', () => showDetail(station.id));
                }

                // LIST CARD LOGIC: Für ALLE Stationen (inkl. 0)
                const card = document.createElement('div');
                card.className = 'station-card p-4 bg-white border border-gray-100 rounded shadow-sm cursor-pointer transition';
                card.innerHTML = `<h3 class="font-bold font-serif text-lg">${station.title}</h3><p class="text-[11px] text-gray-400">${station.short}</p>`;
                card.onclick = () => {
                    map.flyTo(station.coords, 17);
                    showDetail(station.id);
                };
                listContainer.appendChild(card);
            });

            // Initialisiere Drag Funktion für das Station Modal
            makeDraggable(document.getElementById("station-modal-content"));
        }

        // Hilfsfunktion für Fullscreen
        window.openFullscreen = function(src) {
            document.getElementById('fullscreen-image').src = src;
            document.getElementById('fullscreen-overlay').classList.remove('hidden');
        };

        function showDetail(id) {
            const station = stations.find(s => s.id === id);
            if (!station) return;

            document.getElementById('modal-title').innerText = station.title;
            document.getElementById('modal-content-text').innerHTML = station.content;
            
            const imgContainer = document.getElementById('modal-image-container');
            if (station.image) {
                // UPDATE: Mit onclick Event für Fullscreen und Zoom-Cursor
                imgContainer.innerHTML = `<img src="${station.image}" class="w-auto h-auto max-w-full max-h-[50vh] object-contain shadow-md cursor-zoom-in" alt="${station.title}" onclick="openFullscreen('${station.image}')" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'text-gray-400 italic p-4 text-center\\'>Bild nicht gefunden:<br>${station.image}</div>'">`;
                
                // Add magnifying glass overlay (via CSS classes in HTML above, logic here ensures structure)
                const overlayDiv = document.createElement('div');
                overlayDiv.className = "absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition-all flex items-center justify-center pointer-events-none";
                overlayDiv.innerHTML = `<svg class="text-white opacity-0 transition-opacity drop-shadow-md" style="opacity: 0;" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>`;
                
                // Hover effect logic needed since innerHTML rebuilds
                
                imgContainer.innerHTML = `
                    <div class="relative group cursor-zoom-in" onclick="openFullscreen('${station.image}')">
                        <img src="${station.image}" class="w-auto h-auto max-w-full max-h-[50vh] object-contain shadow-md" alt="${station.title}" onerror="this.onerror=null; this.closest('#modal-image-container').innerHTML='<div class=\\'text-gray-400 italic p-4 text-center\\'>Bild nicht gefunden:<br>${station.image}</div>'">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all flex items-center justify-center">
                            <svg class="text-white opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-lg" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                        </div>
                    </div>
                `;
                
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.classList.add('hidden');
            }

            // --- BILDNACHWEIS LOGIK ---
            const captionContainer = document.getElementById('modal-image-copyright');
            if (station.image && station.imageCopyright) {
                captionContainer.innerText = "Foto: " + station.imageCopyright;
                captionContainer.classList.remove('hidden');
            } else {
                captionContainer.classList.add('hidden');
            }

            const mediaContainer = document.getElementById('modal-media');
            mediaContainer.innerHTML = '';
            
            if (station.audio || station.model3d) {
                mediaContainer.classList.remove('hidden');
                mediaContainer.innerHTML = `<h4 class="font-serif font-bold mb-3 text-sm border-b border-gray-200 pb-1">Multimediale Inhalte</h4>`;
                
                if (station.audio) {
                    const audioDiv = document.createElement('div');
                    audioDiv.className = 'mb-3';
                    audioDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Audio-Guide</span>
                        </div>
                        <audio controls class="w-full h-8 rounded bg-[#f4f1ea]">
                            <source src="${station.audio}" type="audio/mpeg">
                            Ihr Browser unterstützt das Audio-Element nicht.
                        </audio>
                    `;
                    mediaContainer.appendChild(audioDiv);
                }

                if (station.model3d) {
                    const modelBtn = document.createElement('button');
                    modelBtn.className = 'w-full py-2 border border-[#a67c00] text-[#a67c00] rounded hover:bg-[#a67c00] hover:text-white transition flex items-center justify-center gap-2 text-sm font-medium';
                    modelBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.5 22.37a.997.997 0 0 0 .5 0l7.5-4a1 1 0 0 0 .5-.86v-8l-8 4.25-8-4.25v8a1 1 0 0 0 .5.86l7.5 4Z"/><path d="M3 7l9-5 9 5M12 22V12"/></svg> 3D-Scan ansehen`;
                    modelBtn.onclick = () => {
                         showToast("Platzhalter: 3D-Viewer für Modell " + station.model3d);
                    };
                    mediaContainer.appendChild(modelBtn);
                }
            } else {
                mediaContainer.classList.add('hidden');
            }

            // NAVIGATION BUTTONS LOGIC
            const currentIndex = stations.findIndex(s => s.id === id);
            const nextStation = stations[currentIndex + 1];
            const nextBtn = document.getElementById('modal-next-btn');
            
            if (nextStation) {
                nextBtn.innerHTML = `<span>Zur nächsten Station: ${nextStation.title}</span><svg class="ml-2 group-hover:translate-x-1 transition-transform" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`;
                nextBtn.onclick = () => {
                    document.getElementById('station-overlay').classList.remove('active');
                    // MODIFIZIERT: Startet Route von aktueller Station zur nächsten (für Screenshots/Tour-Modus)
                    startRoute(nextStation.coords, station.coords);
                };
                nextBtn.classList.remove('hidden');
            } else {
                nextBtn.innerHTML = `<span>Rundgang beendet</span>`;
                nextBtn.onclick = () => document.getElementById('station-overlay').classList.remove('active');
            }

            // Standard Navigation button (to this station)
            document.getElementById('modal-navigate-btn').onclick = () => {
                document.getElementById('station-overlay').classList.remove('active');
                startRoute(station.coords);
            };

            // Show Modal - Reset Position to center when opening new
            const modalContent = document.getElementById("station-modal-content");
            modalContent.style.top = "50%";
            modalContent.style.left = "50%";
            modalContent.style.transform = "translate(-50%, -50%)";

            document.getElementById('station-overlay').classList.add('active');
        }

        function showArrivalPrompt(station) {
            const prompt = document.getElementById('arrival-prompt');
            document.getElementById('arrival-station-name').innerText = station.title;
            
            // Setup Open Action
            document.getElementById('openArrival').onclick = () => {
                prompt.classList.remove('visible');
                showDetail(station.id);
            };

            prompt.classList.add('visible');
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text; toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        function updateNavigator() {
            if (!userLocation) return;
            document.getElementById('nav-initial-state').classList.add('hidden');
            document.getElementById('nav-active-state').classList.remove('hidden');

            let nearest = null;
            let minDist = Infinity;
            stations.forEach(s => {
                const dist = L.latLng(userLocation.lat, userLocation.lng).distanceTo(L.latLng(s.coords[0], s.coords[1]));
                if (dist < minDist) { minDist = dist; nearest = s; }
            });

            if (nearest) {
                document.getElementById('nav-next-title').innerText = nearest.title;
                const distText = minDist > 1000 ? (minDist/1000).toFixed(1) + " km" : Math.round(minDist) + " m";
                document.getElementById('nav-dist').innerText = distText;
                const minutes = Math.ceil(minDist / 80);
                document.getElementById('nav-time').innerText = minutes + " Min.";
                
                const statusText = document.getElementById('nav-status-text');
                
                if (minDist < 40) { // Arrival Zone
                    statusText.innerHTML = `<span class="h-2 w-2 rounded-full bg-red-600 animate-pulse mr-2"></span> Ziel erreicht!`;
                    statusText.classList.remove('text-green-600');
                    statusText.classList.add('text-red-600');

                    if (!currentHighlightLayer || currentHighlightLayer._latlng.lat !== nearest.coords[0]) {
                        if (currentHighlightLayer) map.removeLayer(currentHighlightLayer);
                        currentHighlightLayer = L.circle(nearest.coords, {
                            color: '#e74c3c', fillColor: '#c0392b', fillOpacity: 0.3, radius: 35, className: 'arrival-marker'
                        }).addTo(map);
                        
                        // NEW: Prompt instead of auto-open
                        if (lastTriggeredStationId !== nearest.id) {
                            showArrivalPrompt(nearest);
                            lastTriggeredStationId = nearest.id;
                        }
                    }
                } else {
                    statusText.innerHTML = `<span class="h-1.5 w-1.5 rounded-full bg-green-600 mr-1"></span> Aktiv`;
                    statusText.classList.add('text-green-600');
                    statusText.classList.remove('text-red-600');
                    if (currentHighlightLayer) {
                        map.removeLayer(currentHighlightLayer);
                        currentHighlightLayer = null;
                        
                        // Only reset if we move away significantly to avoid flicker? 
                        // For now, reset when leaving the zone is fine.
                        // lastTriggeredStationId = null; // Removed to prevent re-triggering if user just walks back and forth. 
                    }
                    // Hide prompt if user walks away without clicking
                    document.getElementById('arrival-prompt').classList.remove('visible');
                }
            }
        }

        function startRoute(destCoords, startCoords = null) {
            // Wenn startCoords übergeben, nutze diese (Simulations/Screenshot-Modus)
            // Sonst nutze userLocation (GPS-Modus)
            let start = null;
            
            if (startCoords) {
                start = L.latLng(startCoords[0], startCoords[1]);
            } else if (userLocation) {
                start = L.latLng(userLocation.lat, userLocation.lng);
            }

            if (!start) { showToast("Bitte erst GPS aktivieren."); return; }
            
            if (routingControl) map.removeControl(routingControl);
            
            showToast("Berechne Route...");

            routingControl = L.Routing.control({
                waypoints: [start, L.latLng(destCoords[0], destCoords[1])],
                createMarker: () => null,
                language: 'de',
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://routing.openstreetmap.de/routed-foot/route/v1',
                    profile: 'foot' 
                }),
                lineOptions: { 
                    styles: [{ color: '#d60000', opacity: 0.8, weight: 6 }],
                    extendToWaypoints: true,
                    missingRouteTolerance: 10
                },
                fitSelectedRoutes: true, // Zoomt automatisch auf die Route
                show: false // Versteckt das Text-Panel
            }).addTo(map);

            // Error Handling für Routing
            routingControl.on('routingerror', function(e) {
                console.error("Routing Error:", e);
                showToast("Fehler bei der Routenberechnung.");
            });
        }

        document.getElementById('locateMe').onclick = () => {
            if (!navigator.geolocation) return showToast("GPS nicht unterstützt.");
            navigator.geolocation.watchPosition((position) => {
                const { latitude, longitude } = position.coords;
                userLocation = { lat: latitude, lng: longitude };
                if (userMarker) userMarker.setLatLng([latitude, longitude]);
                else userMarker = L.circleMarker([latitude, longitude], { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map);
                document.getElementById('gps-icon').setAttribute('stroke', '#3b82f6');
                updateNavigator();
            }, () => showToast("GPS Zugriff verweigert."), { enableHighAccuracy: true });
        };

        // Entfernt: BackToList (Wird durch Modal Close ersetzt)
        document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');

        window.onload = initApp;
    </script>
</body>
</html>
