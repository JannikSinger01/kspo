<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koloniale Spuren Osnabrück | Digitale Stadtführung</title>
    
    <!-- Tailwind CSS für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Inter:wght@300;400;600&display=swap');

        :root {
            --vintage-paper: #f4f1ea;
            --charcoal: #2d3436;
            --accent-gold: #a67c00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--vintage-paper);
            color: var(--charcoal);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1, h2, h3 {
            font-family: 'Crimson Pro', serif;
        }

        #map {
            flex-grow: 1;
            z-index: 1;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            background: var(--vintage-paper);
            color: var(--charcoal);
            border-radius: 4px;
            border: 1px solid var(--accent-gold);
        }

        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }

        .station-card:hover {
            border-left: 4px solid var(--accent-gold);
            background: rgba(166, 124, 0, 0.05);
        }

        .leaflet-control-layers {
            border-radius: 8px !important;
            border: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        /* Verstecke Standard-Routing-Anweisungen */
        .leaflet-routing-container {
            display: none !important;
        }

        /* Navigator Panel Styling */
        #navigator-panel {
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-[#2d3436] text-white p-4 shadow-md flex justify-between items-center relative z-[1001]">
        <div>
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight">Koloniale Spuren Osnabrück</h1>
            <p class="text-xs text-gray-400 font-light italic">Ein geschichtswissenschaftliches Projekt zur Stadtführung</p>
        </div>
        <button id="toggleSidebar" class="md:hidden bg-accent-gold p-2 rounded">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
    </header>

    <main class="flex flex-1 relative">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar absolute md:relative w-full md:w-96 bg-[#fdfcf9] border-r border-gray-200 h-full overflow-y-auto transform -translate-x-full md:translate-x-0 shadow-xl">
            <div class="p-6">
                <div id="intro-view">
                    <h2 class="text-2xl mb-4 border-b border-gray-200 pb-2">Stationen der Tour</h2>
                    <p class="text-sm text-gray-600 mb-6">Entdecken Sie die kolonialen Verflechtungen Osnabrücks vor Ort.</p>
                    <div id="station-list" class="space-y-4"></div>
                </div>

                <div id="detail-view" class="hidden">
                    <button id="backToList" class="text-sm text-accent-gold flex items-center mb-4 hover:underline">
                        <svg class="mr-1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> Zurück zur Übersicht
                    </button>
                    <h2 id="detail-title" class="text-2xl mb-2"></h2>
                    <div id="detail-image" class="w-full h-48 bg-gray-200 rounded mb-4 flex items-center justify-center italic text-gray-400 text-sm border">
                        [Bildplatzhalter: Historische Ansicht]
                    </div>
                    <div id="detail-content" class="text-sm leading-relaxed text-gray-700 space-y-4"></div>
                    <div class="mt-8 pt-4 border-t">
                        <button id="startNavigation" class="w-full bg-[#2d3436] text-white py-3 rounded-lg flex justify-center items-center hover:bg-black transition">
                            <svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                            Wegbeschreibung starten
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map -->
        <div id="map"></div>

        <!-- Navigator Overlay (Bottom Right) -->
        <div id="navigator-panel" class="absolute bottom-6 right-6 z-[1000] flex flex-col items-end gap-3 pointer-events-none">
            
            <!-- GPS Status / Info Card -->
            <div id="nav-info-card" class="bg-white/95 p-4 rounded-xl border border-gray-200 w-64 md:w-72 pointer-events-auto transition-all duration-300 transform translate-y-2 opacity-0">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] uppercase tracking-widest text-accent-gold font-bold">Nächste Station</span>
                    <span id="nav-dist" class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">-- m</span>
                </div>
                <h4 id="nav-next-title" class="text-sm font-bold truncate">Standort aktivieren...</h4>
                
                <div class="grid grid-cols-2 gap-2 mt-4 pt-3 border-t border-gray-100">
                    <div>
                        <p class="text-[9px] text-gray-400 uppercase">Gehzeit ca.</p>
                        <p id="nav-time" class="text-sm font-semibold">-- Min.</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-gray-400 uppercase">Tour Gesamt</p>
                        <p id="nav-total" class="text-sm font-semibold">~ 45 Min.</p>
                    </div>
                </div>
            </div>

            <!-- Main GPS Action Button -->
            <button id="locateMe" class="bg-white p-4 rounded-full shadow-lg border border-gray-100 hover:bg-gray-50 active:scale-90 transition-all pointer-events-auto">
                <svg id="gps-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a67c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="22"></line><line x1="2" y1="12" x2="4" y2="12"></line><line x1="20" y1="12" x2="22" y2="12"></line></svg>
            </button>
        </div>
    </main>

    <div id="toast" class="fixed bottom-32 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-2 rounded-full text-xs opacity-0 transition-opacity z-[2000] pointer-events-none shadow-2xl">
        Standort wird abgerufen...
    </div>

    <script>
        const stations = [
            { id: 1, title: "Marktplatz & Rathaus", coords: [52.2776, 8.0411], short: "Handel und Diplomatie.", content: "<p>Das Rathaus ist Symbol der globalen Vernetzung Osnabrücks durch den Westfälischen Frieden.</p>" },
            { id: 2, title: "Bucksturm", coords: [52.2745, 8.0385], short: "Militarismus & Kolonialismus.", content: "<p>Historischer Reflexionspunkt über koloniale Denkmalkultur.</p>" },
            { id: 3, title: "Ledenhof", coords: [52.2725, 8.0445], short: "Globaler Warenimport.", content: "<p>Sitz wohlhabender Familien, die mit Kolonialwaren handelten.</p>" }
        ];

        // Layer-Setup
        const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' });

        const map = L.map('map', { zoomControl: false, layers: [lightLayer] }).setView([52.277, 8.042], 15);
        L.control.layers({ "Archiv": lightLayer, "Satellit": satelliteLayer }, null, { position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        let userLocation = null;
        let routingControl = null;
        let userMarker = null;

        function initApp() {
            const listContainer = document.getElementById('station-list');
            stations.forEach(station => {
                const marker = L.marker(station.coords).addTo(map);
                marker.bindPopup(`<div class="font-bold">${station.title}</div><button onclick="showDetail(${station.id})" class="text-accent-gold text-xs underline mt-1">Details</button>`, { className: 'custom-popup' });

                const card = document.createElement('div');
                card.className = 'station-card p-4 bg-white border border-gray-100 rounded shadow-sm cursor-pointer';
                card.innerHTML = `<h3 class="font-bold">${station.title}</h3><p class="text-[11px] text-gray-400">${station.short}</p>`;
                card.onclick = () => { showDetail(station.id); map.flyTo(station.coords, 17); };
                listContainer.appendChild(card);
            });
        }

        function showDetail(id) {
            const station = stations.find(s => s.id === id);
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            document.getElementById('detail-title').innerText = station.title;
            document.getElementById('detail-content').innerHTML = station.content;
            document.getElementById('startNavigation').onclick = () => startRoute(station.coords);
        }

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.innerText = text; toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        // --- NAVIGATOR LOGIK ---

        function updateNavigator() {
            if (!userLocation) return;

            // Zeige Card
            const card = document.getElementById('nav-info-card');
            card.classList.remove('opacity-0', 'translate-y-2');

            // Finde die nächste Station (Luftlinie)
            let nearest = null;
            let minDist = Infinity;

            stations.forEach(s => {
                const dist = L.latLng(userLocation.lat, userLocation.lng).distanceTo(L.latLng(s.coords[0], s.coords[1]));
                if (dist < minDist) {
                    minDist = dist;
                    nearest = s;
                }
            });

            if (nearest) {
                document.getElementById('nav-next-title').innerText = nearest.title;
                
                // Distanz Formatierung
                const distText = minDist > 1000 ? (minDist/1000).toFixed(1) + " km" : Math.round(minDist) + " m";
                document.getElementById('nav-dist').innerText = distText;

                // Zeitberechnung (ca. 80m pro Minute)
                const minutes = Math.ceil(minDist / 80);
                document.getElementById('nav-time').innerText = minutes + " Min.";
            }
        }

        function startRoute(destCoords) {
            if (!userLocation) {
                showToast("Bitte erst GPS aktivieren.");
                return;
            }
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLocation.lat, userLocation.lng), L.latLng(destCoords[0], destCoords[1])],
                createMarker: () => null,
                language: 'de',
                lineOptions: { styles: [{ color: '#a67c00', opacity: 0.8, weight: 6 }] }
            }).addTo(map);
            showToast("Route gestartet.");
        }

        document.getElementById('locateMe').onclick = () => {
            if (!navigator.geolocation) return showToast("GPS nicht unterstützt.");
            
            navigator.geolocation.watchPosition((position) => {
                const { latitude, longitude } = position.coords;
                userLocation = { lat: latitude, lng: longitude };

                if (userMarker) userMarker.setLatLng([latitude, longitude]);
                else userMarker = L.circleMarker([latitude, longitude], { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map);
                
                document.getElementById('gps-icon').setAttribute('stroke', '#3b82f6');
                updateNavigator();
            }, () => showToast("GPS Zugriff verweigert."), { enableHighAccuracy: true });
        };

        document.getElementById('backToList').onclick = () => {
            document.getElementById('intro-view').classList.remove('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            if (routingControl) map.removeControl(routingControl);
        };

        document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');

        window.onload = initApp;
    </script>
</body>
</html>
